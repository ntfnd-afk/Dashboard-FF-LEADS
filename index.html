<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF Dashboard - Система управления лидами</title>
    <meta name="theme-color" content="#0b0f19">
    <meta name="description" content="FF Dashboard - Система управления лидами и расчета стоимости услуг фулфилмента">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0b0f19',
                        secondary: '#1e293b',
                        accent: '#3b82f6'
                    }
                }
            }
        }
    </script>
    
    <!-- External Libraries -->
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Google Sheets API -->
    <script src="google-sheets-api.js"></script>
    
    <style>
        .hidden { display: none !important; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 51;
        }
        .tab-content {
            display: block;
        }
        .tab-content.hidden {
            display: none;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        .tab-button.active.dark {
            color: #60a5fa;
        }
        .kanban-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: grab;
            transition: all 0.2s;
        }
        .kanban-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        .dark .kanban-card {
            background: #374151;
            border-color: #4b5563;
        }
        .reminder-item {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        .dark .reminder-item {
            background: #451a03;
            border-left-color: #f59e0b;
        }

        #connectionStatus.online {
            background-color: #10b981;
            color: white;
        }

        #connectionStatus.offline {
            background-color: #ef4444;
            color: white;
        }

        #statusDot.online {
            background-color: #10b981;
        }

        #statusDot.offline {
            background-color: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <div id="app">
        <!-- Header -->
        <header class="bg-primary text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <i data-lucide="bar-chart-3" class="h-8 w-8 mr-3"></i>
                        <h1 class="text-xl font-bold">FF Dashboard</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Индикатор подключения -->
                        <div id="connectionStatus" class="flex items-center px-3 py-1 rounded-lg">
                            <div id="statusDot" class="w-2 h-2 rounded-full mr-2"></div>
                            <span id="statusText" class="text-sm">Проверка...</span>
                        </div>
                        
                        <button onclick="showNotificationSettings()" class="flex items-center px-3 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg transition-colors">
                            <i data-lucide="bell" class="h-4 w-4 mr-2"></i>
                            Уведомления
                        </button>
                        <button id="createAccountBtn" onclick="showUserRegistrationModal()" class="flex items-center px-3 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors hidden">
                            <i data-lucide="user-plus" class="h-4 w-4 mr-2"></i>
                            Создать аккаунт
                        </button>
                        <button onclick="logoutUser()" class="flex items-center px-3 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                            <i data-lucide="log-out" class="h-4 w-4 mr-2"></i>
                            Выйти
                        </button>
                        <button onclick="syncWithGoogleSheets()" class="flex items-center px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">
                            <i data-lucide="refresh-cw" class="h-4 w-4 mr-2"></i>
                            Синхронизация
                        </button>
                        <button onclick="showPriceDatabase()" class="flex items-center px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                            <i data-lucide="upload" class="h-4 w-4 mr-2"></i>
                            Прайс
                        </button>
                        <button onclick="showExportModal()" class="flex items-center px-3 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors">
                            <i data-lucide="download" class="h-4 w-4 mr-2"></i>
                            Экспорт
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-button active flex items-center px-3 py-4 text-sm font-medium border-b-2 border-blue-500 text-blue-600 dark:text-blue-400">
                        <i data-lucide="bar-chart-3" class="h-4 w-4 mr-2"></i>
                        Дашборд
                    </button>
                    <button onclick="showTab('leads')" id="tab-leads" class="tab-button flex items-center px-3 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300">
                        <i data-lucide="users" class="h-4 w-4 mr-2"></i>
                        Лиды
                    </button>
                    <button onclick="showTab('calculator')" id="tab-calculator" class="tab-button flex items-center px-3 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300">
                        <i data-lucide="calculator" class="h-4 w-4 mr-2"></i>
                        Калькулятор
                    </button>
                    <button onclick="showTab('kanban')" id="tab-kanban" class="tab-button flex items-center px-3 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300">
                        <i data-lucide="columns" class="h-4 w-4 mr-2"></i>
                        Канбан
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Tab Content -->
            <div id="dashboard-content" class="tab-content">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                        Обзор лидов
                    </h2>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-blue-50 dark:bg-blue-900 p-6 rounded-lg">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i data-lucide="users" class="h-8 w-8 text-blue-600 dark:text-blue-400"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-blue-600 dark:text-blue-400">Всего лидов</p>
                                    <p class="text-2xl font-bold text-blue-900 dark:text-blue-100" id="total-leads">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 dark:bg-green-900 p-6 rounded-lg">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i data-lucide="check-circle" class="h-8 w-8 text-green-600 dark:text-green-400"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-green-600 dark:text-green-400">Конверсия</p>
                                    <p class="text-2xl font-bold text-green-900 dark:text-green-100" id="conversion-rate">0%</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 dark:bg-yellow-900 p-6 rounded-lg">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i data-lucide="clock" class="h-8 w-8 text-yellow-600 dark:text-yellow-400"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-yellow-600 dark:text-yellow-400">В работе</p>
                                    <p class="text-2xl font-bold text-yellow-900 dark:text-yellow-100" id="in-progress-leads">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 dark:bg-purple-900 p-6 rounded-lg">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i data-lucide="trending-up" class="h-8 w-8 text-purple-600 dark:text-purple-400"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-purple-600 dark:text-purple-400">Средний чек</p>
                                    <p class="text-2xl font-bold text-purple-900 dark:text-purple-100" id="average-check">0 ₽</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Distribution Chart -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Распределение по статусам</h3>
                        <div id="status-chart" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <!-- Chart will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Recent Leads -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Последние лиды</h3>
                        <div id="recent-leads" class="space-y-3">
                            <!-- Recent leads will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leads Tab Content -->
            <div id="leads-content" class="tab-content hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                            Управление лидами
                        </h2>
                        <button onclick="showAddLeadModal()" class="flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                            Добавить лид
                        </button>
                    </div>
                    
                    <!-- Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Статус</label>
                            <select id="status-filter" onchange="filterLeads()" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                                <option value="">Все статусы</option>
                                <option value="new">Новый</option>
                                <option value="contacted">Связались</option>
                                <option value="quoted">Отправили смету</option>
                                <option value="negotiating">Переговоры</option>
                                <option value="won">Закрыт успешно</option>
                                <option value="lost">Закрыт неуспешно</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Источник</label>
                            <select id="source-filter" onchange="filterLeads()" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                                <option value="">Все источники</option>
                                <option value="website">Сайт</option>
                                <option value="referral">Рекомендация</option>
                                <option value="cold-call">Холодный звонок</option>
                                <option value="social">Социальные сети</option>
                                <option value="other">Другое</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Поиск</label>
                            <input type="text" id="search-filter" onkeyup="filterLeads()" placeholder="Поиск по имени или компании..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        </div>
                        
                        <div class="flex items-end">
                            <button onclick="clearFilters()" class="w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                                Очистить фильтры
                            </button>
                        </div>
                    </div>
                    
                    <!-- Leads Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Клиент</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Статус</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Источник</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Дата создания</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Сумма</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="leadsTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <tr>
                                    <td colspan="6" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                                        Нет лидов. Нажмите "Добавить лид" для начала работы.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Calculator Tab Content -->
            <div id="calculator-content" class="tab-content hidden">
                <!-- Document Info -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                    Просчёт фулфилмента
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Клиент
                        </label>
                        <input type="text" id="clientName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="Название клиента">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Дата
                        </label>
                        <input type="text" id="currentDate" readonly class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Наценка (%)
                        </label>
                        <input type="number" id="markup" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="0" value="0">
                    </div>
                    
                    <div class="flex items-end">
                        <button onclick="clearAll()" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors flex items-center justify-center">
                            <i data-lucide="trash-2" class="h-4 w-4 mr-2"></i>
                            Очистить всё
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Комментарий / примечания
                    </label>
                    <textarea id="comments" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="Дополнительная информация..."></textarea>
                </div>
            </div>

            <!-- Calculation Table -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                            Расчет услуг
                        </h3>
                        <button onclick="addCalculationItem()" class="flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                            Добавить услугу
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">№</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Услуга</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Количество</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Единица</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Цена за единицу</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Итого</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="calculationTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <tr>
                                <td colspan="7" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                                    Нет добавленных услуг. Нажмите "Добавить услугу" для начала расчета.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Totals -->
                <div id="totalsSection" class="px-6 py-4 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600 hidden">
                    <div class="flex justify-end">
                        <div class="w-64 space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600 dark:text-gray-300">Промежуточный итог:</span>
                                <span id="subtotal" class="font-medium text-gray-900 dark:text-white">0 ₽</span>
                            </div>
                            <div id="markupRow" class="flex justify-between text-sm hidden">
                                <span class="text-gray-600 dark:text-gray-300">Наценка:</span>
                                <span id="markupAmount" class="font-medium text-gray-900 dark:text-white">0 ₽</span>
                            </div>
                            <div class="flex justify-between text-lg font-bold border-t border-gray-300 dark:border-gray-500 pt-2">
                                <span class="text-gray-900 dark:text-white">Итого по ТЗ:</span>
                                <span id="total" class="text-blue-600 dark:text-blue-400">0 ₽</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kanban Tab Content -->
            <div id="kanban-content" class="tab-content hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                            Канбан воронки продаж
                        </h2>
                        <div class="flex space-x-4">
                            <button onclick="showAddReminderModal()" class="flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                                <i data-lucide="bell-plus" class="h-4 w-4 mr-2"></i>
                                Добавить напоминание
                            </button>
                            <button onclick="showPipelineSettings()" class="flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                                <i data-lucide="settings" class="h-4 w-4 mr-2"></i>
                                Настройки воронки
                            </button>
                        </div>
                    </div>
                    
                    <!-- Pipeline Stages -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-6">
                        <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg" ondrop="drop(event, 'new')" ondragover="allowDrop(event)">
                            <h3 class="font-semibold text-blue-900 dark:text-blue-100 mb-2">Новые лиды</h3>
                            <div class="text-2xl font-bold text-blue-900 dark:text-blue-100 mb-2" id="new-leads-count">0</div>
                            <div id="new-leads-column" class="space-y-2 min-h-[200px]">
                                <!-- Lead cards will be populated here -->
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg" ondrop="drop(event, 'contacted')" ondragover="allowDrop(event)">
                            <h3 class="font-semibold text-yellow-900 dark:text-yellow-100 mb-2">Связались</h3>
                            <div class="text-2xl font-bold text-yellow-900 dark:text-yellow-100 mb-2" id="contacted-leads-count">0</div>
                            <div id="contacted-leads-column" class="space-y-2 min-h-[200px]">
                                <!-- Lead cards will be populated here -->
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg" ondrop="drop(event, 'quoted')" ondragover="allowDrop(event)">
                            <h3 class="font-semibold text-purple-900 dark:text-purple-100 mb-2">Отправили смету</h3>
                            <div class="text-2xl font-bold text-purple-900 dark:text-purple-100 mb-2" id="quoted-leads-count">0</div>
                            <div id="quoted-leads-column" class="space-y-2 min-h-[200px]">
                                <!-- Lead cards will be populated here -->
                            </div>
                        </div>
                        
                        <div class="bg-orange-50 dark:bg-orange-900 p-4 rounded-lg" ondrop="drop(event, 'negotiating')" ondragover="allowDrop(event)">
                            <h3 class="font-semibold text-orange-900 dark:text-orange-100 mb-2">Переговоры</h3>
                            <div class="text-2xl font-bold text-orange-900 dark:text-orange-100 mb-2" id="negotiating-leads-count">0</div>
                            <div id="negotiating-leads-column" class="space-y-2 min-h-[200px]">
                                <!-- Lead cards will be populated here -->
                            </div>
                        </div>
                        
                        <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg" ondrop="drop(event, 'won')" ondragover="allowDrop(event)">
                            <h3 class="font-semibold text-green-900 dark:text-green-100 mb-2">Закрыт успешно</h3>
                            <div class="text-2xl font-bold text-green-900 dark:text-green-100 mb-2" id="won-leads-count">0</div>
                            <div id="won-leads-column" class="space-y-2 min-h-[200px]">
                                <!-- Lead cards will be populated here -->
                            </div>
                        </div>
                        
                        <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg" ondrop="drop(event, 'lost')" ondragover="allowDrop(event)">
                            <h3 class="font-semibold text-red-900 dark:text-red-100 mb-2">Закрыт неуспешно</h3>
                            <div class="text-2xl font-bold text-red-900 dark:text-red-100 mb-2" id="lost-leads-count">0</div>
                            <div id="lost-leads-column" class="space-y-2 min-h-[200px]">
                                <!-- Lead cards will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reminders Section -->
                    <div class="mt-8">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Активные напоминания</h3>
                        <div id="reminders-list" class="space-y-3">
                            <!-- Reminders will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </main>
    </div>

    <!-- Add Lead Modal -->
    <div id="addLeadModal" class="modal-overlay hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Добавить новый лид
                </h3>
                <button onclick="hideAddLeadModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Имя клиента *
                        </label>
                        <input type="text" id="leadClientName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="Название компании или ФИО">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Контактная информация
                        </label>
                        <input type="text" id="leadContact" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="Телефон, email">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Источник *
                        </label>
                        <select id="leadSource" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <option value="">Выберите источник</option>
                            <option value="website">Сайт</option>
                            <option value="referral">Рекомендация</option>
                            <option value="cold-call">Холодный звонок</option>
                            <option value="social">Социальные сети</option>
                            <option value="other">Другое</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Статус
                        </label>
                        <select id="leadStatus" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <option value="new">Новый</option>
                            <option value="contacted">Связались</option>
                            <option value="quoted">Отправили смету</option>
                            <option value="negotiating">Переговоры</option>
                            <option value="won">Закрыт успешно</option>
                            <option value="lost">Закрыт неуспешно</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Комментарии
                    </label>
                    <textarea id="leadComments" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="Дополнительная информация о лиде..."></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Создать расчет для этого лида?
                    </label>
                    <div class="flex items-center">
                        <input type="checkbox" id="createCalculation" class="mr-2">
                        <span class="text-sm text-gray-600 dark:text-gray-300">Да, создать пустой расчет</span>
                    </div>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-4">
                <button onclick="hideAddLeadModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                    Отмена
                </button>
                <button onclick="addLead()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    Добавить лид
                </button>
            </div>
        </div>
    </div>

    <!-- Add Reminder Modal -->
    <div id="addReminderModal" class="modal-overlay hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Добавить напоминание
                </h3>
                <button onclick="hideAddReminderModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Выберите лид *
                        </label>
                        <select id="reminderLeadId" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <option value="">Выберите лид</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Дата и время *
                        </label>
                        <input type="datetime-local" id="reminderDateTime" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Текст напоминания *
                    </label>
                    <textarea id="reminderText" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white" placeholder="Например: Позвонить клиенту, уточнить детали заказа..."></textarea>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Telegram Bot Token (опционально)
                    </label>
                    <input type="text" id="telegramBotToken" placeholder="Оставьте пустым для использования глобальных настроек" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        Если пустое, будут использованы глобальные настройки из раздела "Уведомления"
                    </p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Chat ID (опционально)
                    </label>
                    <input type="text" id="telegramChatId" placeholder="Оставьте пустым для использования глобальных настроек" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        Если пустое, будут использованы глобальные настройки (личные сообщения или группа)
                    </p>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-4">
                <button onclick="hideAddReminderModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                    Отмена
                </button>
                <button onclick="addReminder()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                    Добавить напоминание
                </button>
            </div>
        </div>
    </div>

    <!-- Pipeline Settings Modal -->
    <div id="pipelineSettingsModal" class="modal-overlay hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Настройки воронки продаж
                </h3>
                <button onclick="hidePipelineSettings()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <div class="mb-6">
                    <h4 class="text-md font-medium text-gray-900 dark:text-white mb-4">Этапы воронки</h4>
                    <div id="pipeline-stages" class="space-y-3">
                        <!-- Pipeline stages will be populated here -->
                    </div>
                    <button onclick="addPipelineStage()" class="mt-4 flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                        Добавить этап
                    </button>
                </div>
                
                <div class="mb-6">
                    <h4 class="text-md font-medium text-gray-900 dark:text-white mb-4">Автоматические переходы</h4>
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
                            Настройте автоматические переходы между этапами на основе действий:
                        </p>
                        <div id="auto-transitions" class="space-y-2">
                            <!-- Auto transitions will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-4">
                <button onclick="hidePipelineSettings()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                    Отмена
                </button>
                <button onclick="savePipelineSettings()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                    Сохранить настройки
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Settings Modal -->
    <div id="notificationSettingsModal" class="modal-overlay hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Настройки уведомлений
                </h3>
                <button onclick="hideNotificationSettings()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            
            <div class="p-6">
                <div class="mb-6">
                    <h4 class="text-md font-medium text-gray-900 dark:text-white mb-4">Telegram Bot настройки</h4>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Telegram Bot Token
                        </label>
                        <input type="text" id="globalTelegramBotToken" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            Получите токен у @BotFather в Telegram
                        </p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Тип чата
                        </label>
                        <select id="telegramChatType" onchange="toggleChatTypeSettings()" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <option value="personal">Личные сообщения</option>
                            <option value="group">Группа</option>
                        </select>
                    </div>
                    
                    <div id="personalChatSettings" class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Chat ID (ваш Telegram ID)
                        </label>
                        <input type="text" id="globalTelegramChatId" placeholder="123456789" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            Узнайте свой ID у @userinfobot в Telegram
                        </p>
                    </div>
                    
                    <div id="groupChatSettings" class="mb-4 hidden">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Group Chat ID (ID группы)
                        </label>
                        <input type="text" id="globalTelegramGroupId" placeholder="-123456789" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            ID группы (отрицательное число). Добавьте бота в группу и отправьте любое сообщение
                        </p>
                        
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Ваш Telegram ID для тегов
                            </label>
                            <input type="text" id="globalTelegramUserId" placeholder="123456789" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                Ваш ID для тегов в группе (узнайте у @userinfobot)
                            </p>
                        </div>
                    </div>
                    
                    <button onclick="testTelegramConnection()" class="flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <i data-lucide="send" class="h-4 w-4 mr-2"></i>
                        Тестировать подключение
                    </button>
                </div>
                
                <div class="mb-6">
                    <h4 class="text-md font-medium text-gray-900 dark:text-white mb-4">Браузерные уведомления</h4>
                    
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-900 dark:text-white">Разрешить уведомления</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">Получать уведомления в браузере</div>
                        </div>
                        <button onclick="requestNotificationPermission()" id="notificationPermissionBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                            Разрешить
                        </button>
                    </div>
                    
                    <div id="notificationStatus" class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                        <!-- Status will be shown here -->
                    </div>
                </div>
                
                <div class="mb-6">
                    <h4 class="text-md font-medium text-gray-900 dark:text-white mb-4">Активные напоминания</h4>
                    <div id="globalRemindersList" class="space-y-2">
                        <!-- Reminders will be populated here -->
                    </div>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-4">
                <button onclick="hideNotificationSettings()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                    Закрыть
                </button>
                <button onclick="saveNotificationSettings()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg transition-colors">
                    Сохранить настройки
                </button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Вход в систему
                </h3>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Имя пользователя
                    </label>
                    <input type="text" id="loginUsername" placeholder="manager1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Пароль
                    </label>
                    <input type="password" id="loginPassword" placeholder="••••••••" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                </div>
                
                <div id="loginError" class="mb-4 text-red-600 text-sm hidden"></div>
            </div>
            
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-4">
                <button onclick="loginUser()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    Войти
                </button>
            </div>
        </div>
    </div>

    <!-- User Registration Modal -->
    <div id="userRegistrationModal" class="modal-overlay hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Регистрация пользователя
                </h3>
                <button onclick="hideUserRegistrationModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Имя пользователя *
                    </label>
                    <input type="text" id="userUsername" placeholder="manager1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Полное имя *
                    </label>
                    <input type="text" id="userFullName" placeholder="Иван Петров" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Пароль *
                    </label>
                    <input type="password" id="userPassword" placeholder="••••••••" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Telegram ID (опционально)
                    </label>
                    <input type="text" id="userTelegramId" placeholder="123456789" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        Узнайте свой ID у @userinfobot в Telegram
                    </p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Роль
                    </label>
                    <select id="userRole" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                        <option value="manager">Менеджер</option>
                        <option value="admin">Администратор</option>
                    </select>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-4">
                <button onclick="hideUserRegistrationModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                    Отмена
                </button>
                <button onclick="registerUser()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    Зарегистрировать
                </button>
            </div>
        </div>
    </div>

    <!-- Price Database Modal -->
    <div id="priceDatabaseModal" class="modal-overlay hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
                    База себестоимости (прайс)
                </h2>
                <button onclick="hidePriceDatabase()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <!-- Import/Export Controls -->
                <div class="mb-6 flex flex-wrap gap-4">
                    <button onclick="showGoogleSheetsModal()" class="flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                        <i data-lucide="settings" class="h-4 w-4 mr-2"></i>
                        Настройки Google Sheets
                    </button>
                    <button onclick="showImportModal()" class="flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <i data-lucide="upload" class="h-4 w-4 mr-2"></i>
                        Импорт из CSV
                    </button>
                    <button onclick="exportCSV()" class="flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                        <i data-lucide="download" class="h-4 w-4 mr-2"></i>
                        Экспорт в CSV
                    </button>
                </div>

                <!-- Add New Service -->
                <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">
                        Добавить услугу
                    </h3>
                    <div class="flex gap-4">
                        <input type="text" id="newServiceName" placeholder="Название услуги" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-600 dark:text-white">
                        <input type="number" id="newServicePrice" placeholder="Цена" class="w-32 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-600 dark:text-white" min="0" step="0.01">
                        <button onclick="addService()" class="flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                            Добавить
                        </button>
                    </div>
                </div>

                <!-- Services Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Услуга</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Стоимость, ₽/ед.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="priceDatabaseTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <tr>
                                <td colspan="3" class="px-4 py-12 text-center text-gray-500 dark:text-gray-400">
                                    База услуг пуста. Добавьте услуги или импортируйте из CSV.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                <button onclick="hidePriceDatabase()" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                    Закрыть
                </button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal-overlay hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Импорт из CSV
                </h3>
                <button onclick="hideImportModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            
            <div class="p-6">
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                    Вставьте CSV данные в формате: "Услуга","Стоимость, ₽/ед." или "service","price"
                </p>
                <textarea id="csvText" rows="10" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-600 dark:text-white" placeholder='Услуга,Стоимость, ₽/ед.
Приемка товара,150
Хранение,50
Комплектация,200'></textarea>
            </div>
            
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end space-x-4">
                <button onclick="hideImportModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                    Отмена
                </button>
                <button onclick="importCSV()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    Импортировать
                </button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal-overlay hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
                    Экспорт документа
                </h2>
                <button onclick="hideExportModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>

            <div class="p-6">
                <!-- Export Controls -->
                <div class="mb-6 flex flex-wrap gap-4">
                    <button onclick="generatePDF()" class="flex items-center px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                        <i data-lucide="file-text" class="h-5 w-5 mr-2"></i>
                        Экспорт в PDF
                    </button>
                    <button onclick="generatePNG()" class="flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <i data-lucide="image" class="h-5 w-5 mr-2"></i>
                        Сохранить как PNG
                    </button>
                </div>

                <!-- Preview -->
                <div class="border border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden">
                    <div class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-sm text-gray-600 dark:text-gray-300">
                        Предварительный просмотр документа
                    </div>
                    
                    <div id="exportPreview" class="p-8 bg-white">
                        <!-- Document Header -->
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                                Просчёт фулфилмента
                            </h1>
                            <div class="text-lg text-gray-600 space-y-1">
                                <p id="previewClient" class="hidden"><strong>Клиент:</strong> <span id="previewClientName"></span></p>
                                <p><strong>Дата:</strong> <span id="previewDate"></span></p>
                                <p id="previewMarkup" class="hidden"><strong>Наценка:</strong> <span id="previewMarkupValue"></span>%</p>
                            </div>
                        </div>

                        <!-- Services Table -->
                        <div id="previewTable" class="mb-8 hidden">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border border-gray-300 px-4 py-2 text-left">№</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left">Услуга</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left">Количество</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left">Единица</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left">Цена за единицу</th>
                                        <th class="border border-gray-300 px-4 py-2 text-left">Итого</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                </tbody>
                            </table>
                        </div>

                        <!-- Totals -->
                        <div id="previewTotals" class="mb-8 hidden">
                            <div class="max-w-md ml-auto">
                                <div class="border-t-2 border-gray-400 pt-4 space-y-2">
                                    <div class="flex justify-between text-lg">
                                        <span>Промежуточный итог:</span>
                                        <span id="previewSubtotal">0 ₽</span>
                                    </div>
                                    <div id="previewMarkupRow" class="flex justify-between text-lg hidden">
                                        <span>Наценка (<span id="previewMarkupPercent"></span>%):</span>
                                        <span id="previewMarkupAmount">0 ₽</span>
                                    </div>
                                    <div class="flex justify-between text-2xl font-bold border-t-2 border-gray-400 pt-2">
                                        <span>Итого по ТЗ:</span>
                                        <span id="previewTotal" class="text-blue-600">0 ₽</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Comments -->
                        <div id="previewComments" class="mb-8 hidden">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Комментарии:</h3>
                            <p id="previewCommentsText" class="text-gray-700 whitespace-pre-wrap"></p>
                        </div>

                        <!-- Footer -->
                        <div class="text-center text-sm text-gray-500 mt-8 pt-4 border-t border-gray-300">
                            <p>Документ создан с помощью FF калькулятора сметы</p>
                            <p id="previewFooterDate"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end">
                <button onclick="hideExportModal()" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                    Закрыть
                </button>
            </div>
        </div>
    </div>

    <!-- Google Sheets Settings Modal -->
    <div id="googleSheetsModal" class="modal-overlay hidden">
        <div class="modal-content bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Настройка Google Sheets
                </h3>
                <button onclick="hideGoogleSheetsModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                        Для автоматической синхронизации с Google Sheets необходимо настроить API ключ и ID таблицы.
                    </p>
                    
                    <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg mb-4">
                        <h4 class="font-medium text-blue-900 dark:text-blue-100 mb-2">Как получить API ключ:</h4>
                        <ol class="text-sm text-blue-800 dark:text-blue-200 space-y-1">
                            <li>1. Перейдите в <a href="https://console.developers.google.com/" target="_blank" class="underline">Google Cloud Console</a></li>
                            <li>2. Создайте новый проект или выберите существующий</li>
                            <li>3. Включите Google Sheets API</li>
                            <li>4. Создайте API ключ в разделе "Учетные данные"</li>
                            <li>5. Ограничьте ключ только Google Sheets API</li>
                        </ol>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            API ключ Google Sheets
                        </label>
                        <input type="text" id="gsApiKey" placeholder="AIzaSy..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-600 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            ID таблицы Google Sheets
                        </label>
                        <input type="text" id="gsSpreadsheetId" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-600 dark:text-white">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            ID можно найти в URL таблицы: https://docs.google.com/spreadsheets/d/<strong>ID_ТАБЛИЦЫ</strong>/edit
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Название листа (по умолчанию: Себестоимость)
                        </label>
                        <input type="text" id="gsSheetName" value="Себестоимость" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-600 dark:text-white">
                    </div>
                </div>

                <div id="gsTestResult" class="mt-4 hidden">
                    <div id="gsTestSuccess" class="bg-green-50 dark:bg-green-900 p-3 rounded-lg hidden">
                        <p class="text-green-800 dark:text-green-200 text-sm">
                            <i data-lucide="check-circle" class="h-4 w-4 inline mr-2"></i>
                            <span id="gsTestSuccessMessage"></span>
                        </p>
                    </div>
                    <div id="gsTestError" class="bg-red-50 dark:bg-red-900 p-3 rounded-lg hidden">
                        <p class="text-red-800 dark:text-red-200 text-sm">
                            <i data-lucide="x-circle" class="h-4 w-4 inline mr-2"></i>
                            <span id="gsTestErrorMessage"></span>
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-between">
                <button onclick="testGoogleSheetsConnection()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                    Тестировать подключение
                </button>
                <div class="space-x-4">
                    <button onclick="hideGoogleSheetsModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                        Отмена
                    </button>
                    <button onclick="saveGoogleSheetsSettings()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let priceDatabase = [];
        let calculationItems = [];
        let nextItemId = 1;
        let leads = [];
        let nextLeadId = 1;
        let currentTab = 'dashboard';
        let reminders = [];
        let nextReminderId = 1;
        let currentUser = null;
        let users = [];
        let globalTelegramSettings = {
            botToken: '',
            chatType: 'personal', // 'personal' or 'group'
            chatId: '', // for personal messages
            groupId: '', // for group messages
            userId: '' // user ID for tagging in groups
        };

        // API Configuration
        const API_BASE_URL = 'http://51.250.97.39:3001/api';
        let isOnline = navigator.onLine;

        // Проверка подключения
        window.addEventListener('online', () => {
            isOnline = true;
            console.log('🌐 Подключение восстановлено');
            updateConnectionStatus();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            console.log('❌ Подключение потеряно');
            updateConnectionStatus();
        });
        let pipelineStages = [
            { id: 'new', name: 'Новые лиды', color: 'blue', order: 1 },
            { id: 'contacted', name: 'Связались', color: 'yellow', order: 2 },
            { id: 'quoted', name: 'Отправили смету', color: 'purple', order: 3 },
            { id: 'negotiating', name: 'Переговоры', color: 'orange', order: 4 },
            { id: 'won', name: 'Закрыт успешно', color: 'green', order: 5 },
            { id: 'lost', name: 'Закрыт неуспешно', color: 'red', order: 6 }
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Проверяем авторизацию при загрузке
            const savedUser = localStorage.getItem('ff-current-user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateCurrentUserDisplay();
            } else {
                // Всегда показываем форму входа
                document.getElementById('loginModal').classList.remove('hidden');
            }
            
            // Set current date
            document.getElementById('currentDate').value = new Date().toLocaleDateString('ru-RU');
            
            // Load data from localStorage
            loadData();
            
            // Initialize icons
            lucide.createIcons();
            
            // Add event listeners
            document.getElementById('markup').addEventListener('input', updateTotals);
            
            // Initialize dashboard
            updateDashboard();
            
            // Initialize kanban board
            updateKanbanBoard();
            
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js');
            }
        });

        // Data management
        function saveData() {
            localStorage.setItem('ff-price-database', JSON.stringify(priceDatabase));
            localStorage.setItem('ff-calculation-items', JSON.stringify(calculationItems));
            localStorage.setItem('ff-leads', JSON.stringify(leads));
            localStorage.setItem('ff-next-lead-id', nextLeadId.toString());
            localStorage.setItem('ff-reminders', JSON.stringify(reminders));
            localStorage.setItem('ff-next-reminder-id', nextReminderId.toString());
            localStorage.setItem('ff-pipeline-stages', JSON.stringify(pipelineStages));
            localStorage.setItem('ff-telegram-settings', JSON.stringify(globalTelegramSettings));
            localStorage.setItem('ff-client-name', document.getElementById('clientName').value);
            localStorage.setItem('ff-markup', document.getElementById('markup').value);
            localStorage.setItem('ff-comments', document.getElementById('comments').value);
        }

        async function loadData() {
            try {
                if (isOnline) {
                    // Загружаем данные из API
                    const [leadsResponse, pricesResponse, usersResponse] = await Promise.all([
                        fetch(`${API_BASE_URL}/leads`),
                        fetch(`${API_BASE_URL}/prices`),
                        fetch(`${API_BASE_URL}/users`)
                    ]);

                    if (leadsResponse.ok) {
                        leads = await leadsResponse.json();
                    }
                    if (pricesResponse.ok) {
                        priceDatabase = await pricesResponse.json();
                        updatePriceDatabaseTable();
                    }
                    if (usersResponse.ok) {
                        users = await usersResponse.json();
                    }

                    console.log('✅ Данные загружены из БД');
                } else {
                    // Загружаем из localStorage
                    const savedPriceDatabase = localStorage.getItem('ff-price-database');
                    const savedLeads = localStorage.getItem('ff-leads');
                    const savedUsers = localStorage.getItem('ff-users');

                    if (savedPriceDatabase) {
                        priceDatabase = JSON.parse(savedPriceDatabase);
                        updatePriceDatabaseTable();
                    }
                    if (savedLeads) {
                        leads = JSON.parse(savedLeads);
                    }
                    if (savedUsers) {
                        users = JSON.parse(savedUsers);
                        // Если есть пользователи, делаем первого текущим
                        if (users.length > 0 && !currentUser) {
                            currentUser = users[0];
                            updateCurrentUserDisplay();
                        }
                    }

                    console.log('📱 Данные загружены из localStorage');
                }

                // Загружаем локальные данные
                const savedCalculationItems = localStorage.getItem('ff-calculation-items');
                const savedClientName = localStorage.getItem('ff-client-name');
                const savedMarkup = localStorage.getItem('ff-markup');
                const savedComments = localStorage.getItem('ff-comments');

                if (savedCalculationItems) {
                    calculationItems = JSON.parse(savedCalculationItems);
                    updateCalculationTable();
                }
                if (savedClientName) {
                    document.getElementById('clientName').value = savedClientName;
                }
                if (savedMarkup) {
                    document.getElementById('markup').value = savedMarkup;
                }
                if (savedComments) {
                    document.getElementById('comments').value = savedComments;
                }

            } catch (error) {
                console.error('❌ Ошибка загрузки данных:', error);
                showNotification('Ошибка загрузки данных. Работаем в офлайн режиме.', 'error');
            }
        }

        // Calculation functions
        function addCalculationItem() {
            const newItem = {
                id: nextItemId++,
                service: '',
                quantity: 1,
                unit: 'шт',
                price: 0,
                total: 0
            };
            calculationItems.push(newItem);
            updateCalculationTable();
            saveData();
        }

        function removeCalculationItem(id) {
            calculationItems = calculationItems.filter(item => item.id !== id);
            updateCalculationTable();
            saveData();
        }

        function updateCalculationItem(id, field, value) {
            const item = calculationItems.find(item => item.id === id);
            if (item) {
                item[field] = value;
                if (field === 'quantity' || field === 'price') {
                    item.total = item.quantity * item.price;
                }
                updateCalculationTable();
                saveData();
            }
        }

        function updateCalculationTable() {
            const tbody = document.getElementById('calculationTableBody');
            const totalsSection = document.getElementById('totalsSection');
            
            if (calculationItems.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                            Нет добавленных услуг. Нажмите "Добавить услугу" для начала расчета.
                        </td>
                    </tr>
                `;
                totalsSection.classList.add('hidden');
                return;
            }

            tbody.innerHTML = calculationItems.map((item, index) => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                        ${index + 1}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <select onchange="handleServiceChange(${item.id}, this.value)" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <option value="">Выберите услугу</option>
                            ${priceDatabase.map(service => `
                                <option value="${service.service}" ${item.service === service.service ? 'selected' : ''}>${service.service}</option>
                            `).join('')}
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="number" value="${item.quantity}" onchange="updateCalculationItem(${item.id}, 'quantity', parseFloat(this.value) || 0)" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white" min="0" step="0.01">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <select onchange="updateCalculationItem(${item.id}, 'unit', this.value)" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            <option value="шт" ${item.unit === 'шт' ? 'selected' : ''}>шт</option>
                            <option value="короб" ${item.unit === 'короб' ? 'selected' : ''}>короб</option>
                            <option value="палет" ${item.unit === 'палет' ? 'selected' : ''}>палет</option>
                            <option value="рейс" ${item.unit === 'рейс' ? 'selected' : ''}>рейс</option>
                            <option value="кг" ${item.unit === 'кг' ? 'selected' : ''}>кг</option>
                            <option value="м³" ${item.unit === 'м³' ? 'selected' : ''}>м³</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="number" value="${item.price}" onchange="updateCalculationItem(${item.id}, 'price', parseFloat(this.value) || 0)" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white" min="0" step="0.01">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                        ${item.total.toLocaleString('ru-RU')} ₽
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="removeCalculationItem(${item.id})" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            totalsSection.classList.remove('hidden');
            updateTotals();
            lucide.createIcons();
        }

        function handleServiceChange(id, serviceName) {
            const service = priceDatabase.find(s => s.service === serviceName);
            if (service) {
                updateCalculationItem(id, 'price', service.price);
            }
            updateCalculationItem(id, 'service', serviceName);
        }

        function updateTotals() {
            const subtotal = calculationItems.reduce((sum, item) => sum + item.total, 0);
            const markup = parseFloat(document.getElementById('markup').value) || 0;
            const markupAmount = (subtotal * markup) / 100;
            const total = subtotal + markupAmount;

            document.getElementById('subtotal').textContent = subtotal.toLocaleString('ru-RU') + ' ₽';
            document.getElementById('markupAmount').textContent = markupAmount.toLocaleString('ru-RU') + ' ₽';
            document.getElementById('total').textContent = total.toLocaleString('ru-RU') + ' ₽';

            const markupRow = document.getElementById('markupRow');
            if (markupAmount > 0) {
                markupRow.classList.remove('hidden');
            } else {
                markupRow.classList.add('hidden');
            }

            saveData();
        }

        function clearAll() {
            if (confirm('Вы уверены, что хотите очистить все данные?')) {
                calculationItems = [];
                document.getElementById('clientName').value = '';
                document.getElementById('markup').value = '0';
                document.getElementById('comments').value = '';
                updateCalculationTable();
                saveData();
            }
        }

        // Price database functions
        function showPriceDatabase() {
            document.getElementById('priceDatabaseModal').classList.remove('hidden');
        }

        function hidePriceDatabase() {
            document.getElementById('priceDatabaseModal').classList.add('hidden');
        }

        function addService() {
            const name = document.getElementById('newServiceName').value.trim();
            const price = parseFloat(document.getElementById('newServicePrice').value) || 0;

            if (name && price > 0) {
                priceDatabase.push({ service: name, price: price });
                updatePriceDatabaseTable();
                document.getElementById('newServiceName').value = '';
                document.getElementById('newServicePrice').value = '';
                saveData();
            }
        }

        function removeService(index) {
            priceDatabase.splice(index, 1);
            updatePriceDatabaseTable();
            saveData();
        }

        function updateService(index, field, value) {
            priceDatabase[index][field] = value;
            updatePriceDatabaseTable();
            saveData();
        }

        function updatePriceDatabaseTable() {
            const tbody = document.getElementById('priceDatabaseTableBody');
            
            if (priceDatabase.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-4 py-12 text-center text-gray-500 dark:text-gray-400">
                            База услуг пуста. Добавьте услуги или импортируйте из CSV.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = priceDatabase.map((service, index) => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-4 py-4 whitespace-nowrap">
                        <input type="text" value="${service.service}" onchange="updateService(${index}, 'service', this.value)" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-600 dark:text-white">
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <input type="number" value="${service.price}" onchange="updateService(${index}, 'price', parseFloat(this.value) || 0)" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-600 dark:text-white" min="0" step="0.01">
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <button onclick="removeService(${index})" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                            <i data-lucide="trash-2" class="h-4 w-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            lucide.createIcons();
        }

        // Import/Export functions
        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.add('hidden');
        }

        function importCSV() {
            const csvText = document.getElementById('csvText').value.trim();
            if (!csvText) return;

            try {
                const result = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: (header) => header.toLowerCase().trim()
                });

                if (result.errors.length > 0) {
                    alert('Ошибка при парсинге CSV: ' + result.errors[0].message);
                    return;
                }

                const importedData = result.data.map(row => ({
                    service: row.услуга || row.service || '',
                    price: parseFloat(row['стоимость, ₽/ед.'] || row.price || 0)
                })).filter(item => item.service && !isNaN(item.price));

                priceDatabase = importedData;
                updatePriceDatabaseTable();
                document.getElementById('csvText').value = '';
                hideImportModal();
                alert(`Успешно импортировано ${importedData.length} услуг`);
                saveData();
            } catch (error) {
                alert('Ошибка при импорте: ' + error.message);
            }
        }

        function exportCSV() {
            const csv = Papa.unparse(priceDatabase.map(item => ({
                'Услуга': item.service,
                'Стоимость, ₽/ед.': item.price
            })));

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'price-database.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Export functions
        function showExportModal() {
            updateExportPreview();
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function hideExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function updateExportPreview() {
            const clientName = document.getElementById('clientName').value;
            const markup = parseFloat(document.getElementById('markup').value) || 0;
            const comments = document.getElementById('comments').value;
            
            const subtotal = calculationItems.reduce((sum, item) => sum + item.total, 0);
            const markupAmount = (subtotal * markup) / 100;
            const total = subtotal + markupAmount;

            // Update header
            if (clientName) {
                document.getElementById('previewClient').classList.remove('hidden');
                document.getElementById('previewClientName').textContent = clientName;
            } else {
                document.getElementById('previewClient').classList.add('hidden');
            }

            document.getElementById('previewDate').textContent = new Date().toLocaleDateString('ru-RU');
            
            if (markup > 0) {
                document.getElementById('previewMarkup').classList.remove('hidden');
                document.getElementById('previewMarkupValue').textContent = markup;
            } else {
                document.getElementById('previewMarkup').classList.add('hidden');
            }

            // Update table
            if (calculationItems.length > 0) {
                document.getElementById('previewTable').classList.remove('hidden');
                document.getElementById('previewTableBody').innerHTML = calculationItems.map((item, index) => `
                    <tr>
                        <td class="border border-gray-300 px-4 py-2">${index + 1}</td>
                        <td class="border border-gray-300 px-4 py-2">${item.service}</td>
                        <td class="border border-gray-300 px-4 py-2">${item.quantity}</td>
                        <td class="border border-gray-300 px-4 py-2">${item.unit}</td>
                        <td class="border border-gray-300 px-4 py-2 text-right">${item.price.toLocaleString('ru-RU')} ₽</td>
                        <td class="border border-gray-300 px-4 py-2 text-right font-medium">${item.total.toLocaleString('ru-RU')} ₽</td>
                    </tr>
                `).join('');
            } else {
                document.getElementById('previewTable').classList.add('hidden');
            }

            // Update totals
            document.getElementById('previewTotals').classList.remove('hidden');
            document.getElementById('previewSubtotal').textContent = subtotal.toLocaleString('ru-RU') + ' ₽';
            
            if (markupAmount > 0) {
                document.getElementById('previewMarkupRow').classList.remove('hidden');
                document.getElementById('previewMarkupPercent').textContent = markup;
                document.getElementById('previewMarkupAmount').textContent = markupAmount.toLocaleString('ru-RU') + ' ₽';
            } else {
                document.getElementById('previewMarkupRow').classList.add('hidden');
            }
            
            document.getElementById('previewTotal').textContent = total.toLocaleString('ru-RU') + ' ₽';

            // Update comments
            if (comments) {
                document.getElementById('previewComments').classList.remove('hidden');
                document.getElementById('previewCommentsText').textContent = comments;
            } else {
                document.getElementById('previewComments').classList.add('hidden');
            }

            document.getElementById('previewFooterDate').textContent = new Date().toLocaleString('ru-RU');
        }

        async function generatePDF() {
            try {
                const element = document.getElementById('exportPreview');
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                const fileName = `ff-quote-${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
            } catch (error) {
                alert('Ошибка при создании PDF: ' + error.message);
            }
        }

        async function generatePNG() {
            try {
                const element = document.getElementById('exportPreview');
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true
                });

                const link = document.createElement('a');
                link.download = `ff-quote-${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
            } catch (error) {
                alert('Ошибка при создании PNG: ' + error.message);
            }
        }

        // Auto-save on input changes
        document.getElementById('clientName').addEventListener('input', saveData);
        document.getElementById('comments').addEventListener('input', saveData);

        // Google Sheets Integration Functions
        function showGoogleSheetsModal() {
            // Загружаем сохраненные настройки
            gsAPI.loadSettings();
            document.getElementById('gsApiKey').value = gsAPI.apiKey;
            document.getElementById('gsSpreadsheetId').value = gsAPI.spreadsheetId;
            document.getElementById('gsSheetName').value = gsAPI.sheetName;
            
            document.getElementById('googleSheetsModal').classList.remove('hidden');
        }

        function hideGoogleSheetsModal() {
            document.getElementById('googleSheetsModal').classList.add('hidden');
            document.getElementById('gsTestResult').classList.add('hidden');
        }

        async function testGoogleSheetsConnection() {
            const apiKey = document.getElementById('gsApiKey').value.trim();
            const spreadsheetId = document.getElementById('gsSpreadsheetId').value.trim();
            const sheetName = document.getElementById('gsSheetName').value.trim();

            if (!apiKey || !spreadsheetId) {
                showTestResult(false, 'Заполните все обязательные поля');
                return;
            }

            // Временно настраиваем API для тестирования
            gsAPI.configure(apiKey, spreadsheetId, sheetName);

            try {
                const result = await gsAPI.testConnection();
                showTestResult(result.success, result.message);
            } catch (error) {
                showTestResult(false, error.message);
            }
        }

        function showTestResult(success, message) {
            const resultDiv = document.getElementById('gsTestResult');
            const successDiv = document.getElementById('gsTestSuccess');
            const errorDiv = document.getElementById('gsTestError');
            const successMessage = document.getElementById('gsTestSuccessMessage');
            const errorMessage = document.getElementById('gsTestErrorMessage');

            resultDiv.classList.remove('hidden');
            
            if (success) {
                successDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');
                successMessage.textContent = message;
            } else {
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
                errorMessage.textContent = message;
            }
            
            lucide.createIcons();
        }

        function saveGoogleSheetsSettings() {
            const apiKey = document.getElementById('gsApiKey').value.trim();
            const spreadsheetId = document.getElementById('gsSpreadsheetId').value.trim();
            const sheetName = document.getElementById('gsSheetName').value.trim();

            if (!apiKey || !spreadsheetId) {
                alert('Заполните все обязательные поля');
                return;
            }

            gsAPI.configure(apiKey, spreadsheetId, sheetName);
            hideGoogleSheetsModal();
            
            // Показываем уведомление об успешном сохранении
            showNotification('Настройки Google Sheets сохранены', 'success');
        }

        async function syncWithGoogleSheets() {
            // Проверяем, настроен ли Google Sheets
            gsAPI.loadSettings();
            
            if (!gsAPI.isConfigured) {
                if (confirm('Google Sheets не настроен. Хотите настроить его сейчас?')) {
                    showGoogleSheetsModal();
                }
                return;
            }

            try {
                // Показываем индикатор загрузки
                const syncButton = event.target;
                const originalText = syncButton.innerHTML;
                syncButton.innerHTML = '<i data-lucide="loader-2" class="h-4 w-4 mr-2 animate-spin"></i>Синхронизация...';
                syncButton.disabled = true;
                
                // Загружаем данные из Google Sheets
                const data = await gsAPI.fetchData();
                
                if (data.length === 0) {
                    throw new Error('Не найдено данных в таблице');
                }

                // Обновляем локальную базу данных
                priceDatabase = data;
                updatePriceDatabaseTable();
                saveData();
                
                showNotification(`Синхронизация завершена. Загружено ${data.length} услуг`, 'success');
                
            } catch (error) {
                console.error('Ошибка синхронизации:', error);
                showNotification(`Ошибка синхронизации: ${error.message}`, 'error');
            } finally {
                // Восстанавливаем кнопку
                syncButton.innerHTML = originalText;
                syncButton.disabled = false;
                lucide.createIcons();
            }
        }

        function showNotification(message, type = 'info') {
            // Создаем уведомление
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Автоматически скрываем через 3 секунды
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Автоматическая синхронизация при загрузке приложения
        async function autoSyncOnLoad() {
            gsAPI.loadSettings();
            
            if (gsAPI.isConfigured) {
                try {
                    const data = await gsAPI.fetchData();
                    if (data.length > 0) {
                        priceDatabase = data;
                        updatePriceDatabaseTable();
                        saveData();
                        console.log(`Автоматически загружено ${data.length} услуг из Google Sheets`);
                    }
                } catch (error) {
                    console.warn('Не удалось выполнить автоматическую синхронизацию:', error.message);
                }
            }
        }

        // Вызываем автоматическую синхронизацию после загрузки данных
        setTimeout(autoSyncOnLoad, 1000);

        // Tab Management Functions
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                button.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                button.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeButton = document.getElementById('tab-' + tabName);
            activeButton.classList.add('active', 'border-blue-500', 'text-blue-600', 'dark:text-blue-400');
            activeButton.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
            
            currentTab = tabName;
            
            // Update content based on tab
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'leads') {
                updateLeadsTable();
            } else if (tabName === 'kanban') {
                updateKanbanBoard();
            }
        }

        // Lead Management Functions
        function showAddLeadModal() {
            document.getElementById('addLeadModal').classList.remove('hidden');
        }

        function hideAddLeadModal() {
            document.getElementById('addLeadModal').classList.add('hidden');
            // Clear form
            document.getElementById('leadClientName').value = '';
            document.getElementById('leadContact').value = '';
            document.getElementById('leadSource').value = '';
            document.getElementById('leadStatus').value = 'new';
            document.getElementById('leadComments').value = '';
            document.getElementById('createCalculation').checked = false;
        }

        async function addLead() {
            const clientName = document.getElementById('leadClientName').value.trim();
            const contact = document.getElementById('leadContact').value.trim();
            const source = document.getElementById('leadSource').value;
            const status = document.getElementById('leadStatus').value;
            const comments = document.getElementById('leadComments').value.trim();
            const createCalculation = document.getElementById('createCalculation').checked;

            if (!clientName || !source) {
                alert('Заполните обязательные поля: Имя клиента и Источник');
                return;
            }

            const newLead = {
                client_name: clientName,
                phone: contact,
                email: '',
                status: status,
                source: source,
                comments: comments,
                user_id: currentUser ? currentUser.id : null
            };

            try {
                if (isOnline) {
                    const response = await fetch(`${API_BASE_URL}/leads`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newLead)
                    });

                    if (response.ok) {
                        const savedLead = await response.json();
                        // Преобразуем формат для совместимости
                        savedLead.clientName = savedLead.client_name;
                        savedLead.contact = savedLead.phone;
                        savedLead.createdAt = savedLead.created_at;
                        savedLead.updatedAt = savedLead.updated_at;
                        savedLead.calculationId = createCalculation ? nextItemId++ : null;
                        savedLead.totalAmount = 0;
                        
                        leads.push(savedLead);
                        showNotification('Лид добавлен', 'success');
                    } else {
                        throw new Error('Ошибка сохранения лида');
                    }
                } else {
                    // Офлайн режим
                    newLead.id = nextLeadId++;
                    newLead.clientName = newLead.client_name;
                    newLead.contact = newLead.phone;
                    newLead.createdAt = new Date().toISOString();
                    newLead.updatedAt = new Date().toISOString();
                    newLead.calculationId = createCalculation ? nextItemId++ : null;
                    newLead.totalAmount = 0;
                    
                    leads.push(newLead);
                    localStorage.setItem('ff-leads', JSON.stringify(leads));
                    showNotification('Лид добавлен (офлайн)', 'success');
                }

                saveData();
                hideAddLeadModal();
                
                // Update current view
                if (currentTab === 'leads') {
                    updateLeadsTable();
                } else if (currentTab === 'dashboard') {
                    updateDashboard();
                }

            } catch (error) {
                console.error('Ошибка добавления лида:', error);
                showNotification('Ошибка добавления лида', 'error');
            }
        }

        // User Management Functions
        function showUserRegistrationModal() {
            // Проверяем права доступа
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Только администраторы могут создавать аккаунты', 'error');
                return;
            }
            document.getElementById('userRegistrationModal').classList.remove('hidden');
        }

        function hideUserRegistrationModal() {
            document.getElementById('userRegistrationModal').classList.add('hidden');
            // Очищаем форму
            document.getElementById('userUsername').value = '';
            document.getElementById('userFullName').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userTelegramId').value = '';
            document.getElementById('userRole').value = 'manager';
        }

        async function registerUser() {
            const username = document.getElementById('userUsername').value.trim();
            const fullName = document.getElementById('userFullName').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            const telegramId = document.getElementById('userTelegramId').value.trim();
            const role = document.getElementById('userRole').value;

            if (!username || !fullName || !password) {
                alert('Заполните обязательные поля: Имя пользователя, Полное имя и Пароль');
                return;
            }

            const newUser = {
                username: username,
                full_name: fullName,
                password: password,
                telegram_id: telegramId || null,
                role: role
            };

            try {
                if (isOnline) {
                    const response = await fetch(`${API_BASE_URL}/users`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newUser)
                    });

                    if (response.ok) {
                        const savedUser = await response.json();
                        users.push(savedUser);
                        showNotification('Пользователь зарегистрирован', 'success');
                        hideUserRegistrationModal();
                        
                        // Если это первый пользователь, делаем его текущим
                        if (!currentUser) {
                            currentUser = savedUser;
                            updateCurrentUserDisplay();
                        }
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Ошибка регистрации пользователя');
                    }
                } else {
                    // Офлайн режим
                    newUser.id = users.length + 1;
                    newUser.created_at = new Date().toISOString();
                    users.push(newUser);
                    localStorage.setItem('ff-users', JSON.stringify(users));
                    showNotification('Пользователь зарегистрирован (офлайн)', 'success');
                    hideUserRegistrationModal();
                    
                    if (!currentUser) {
                        currentUser = newUser;
                        updateCurrentUserDisplay();
                    }
                }
            } catch (error) {
                console.error('Ошибка регистрации пользователя:', error);
                showNotification('Ошибка регистрации: ' + error.message, 'error');
            }
        }

        // Authentication Functions
        async function loginUser() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                showLoginError('Заполните все поля');
                return;
            }

            try {
                if (isOnline) {
                    const response = await fetch(`${API_BASE_URL}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        currentUser = result.user;
                        localStorage.setItem('ff-current-user', JSON.stringify(currentUser));
                        hideLoginModal();
                        updateCurrentUserDisplay();
                        showNotification('Успешный вход в систему', 'success');
                        loadData(); // Перезагружаем данные для авторизованного пользователя
                    } else {
                        const error = await response.json();
                        showLoginError(error.error || 'Ошибка входа');
                    }
                } else {
                    // Офлайн режим - проверяем в localStorage
                    const savedUsers = localStorage.getItem('ff-users');
                    if (savedUsers) {
                        const users = JSON.parse(savedUsers);
                        const user = users.find(u => u.username === username && u.password === password);
                        if (user) {
                            currentUser = user;
                            localStorage.setItem('ff-current-user', JSON.stringify(currentUser));
                            hideLoginModal();
                            updateCurrentUserDisplay();
                            showNotification('Успешный вход в систему (офлайн)', 'success');
                            loadData();
                        } else {
                            showLoginError('Неверные учетные данные');
                        }
                    } else {
                        showLoginError('Пользователи не найдены');
                    }
                }
            } catch (error) {
                console.error('Ошибка входа:', error);
                showLoginError('Ошибка подключения к серверу');
            }
        }

        function logoutUser() {
            currentUser = null;
            localStorage.removeItem('ff-current-user');
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('currentUserInfo')?.remove();
            showNotification('Вы вышли из системы', 'info');
            
            // Очищаем данные
            leads = [];
            reminders = [];
            users = [];
            
            // Обновляем интерфейс
            if (currentTab === 'leads') {
                updateLeadsTable();
            } else if (currentTab === 'dashboard') {
                updateDashboard();
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function updateCurrentUserDisplay() {
            if (currentUser) {
                // Добавляем информацию о текущем пользователе в хедер
                const header = document.querySelector('header .flex.items-center.justify-between');
                if (header && !document.getElementById('currentUserInfo')) {
                    const userInfo = document.createElement('div');
                    userInfo.id = 'currentUserInfo';
                    userInfo.className = 'flex items-center px-3 py-1 bg-green-600 rounded-lg';
                    userInfo.innerHTML = `
                        <i data-lucide="user" class="h-4 w-4 mr-2"></i>
                        <span class="text-sm">${currentUser.full_name}</span>
                        ${currentUser.role === 'admin' ? '<span class="ml-2 px-2 py-1 bg-yellow-500 text-xs rounded">Админ</span>' : ''}
                    `;
                    header.insertBefore(userInfo, header.querySelector('.flex.items-center.space-x-4'));
                }
                
                // Показываем/скрываем админские функции
                const createAccountBtn = document.getElementById('createAccountBtn');
                if (createAccountBtn) {
                    if (currentUser.role === 'admin') {
                        createAccountBtn.classList.remove('hidden');
                    } else {
                        createAccountBtn.classList.add('hidden');
                    }
                }
            }
        }

        function updateLeadsTable() {
            const tbody = document.getElementById('leadsTableBody');
            
            if (leads.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                            Нет лидов. Нажмите "Добавить лид" для начала работы.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = leads.map(lead => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900 dark:text-white">${lead.clientName}</div>
                            ${lead.contact ? `<div class="text-sm text-gray-500 dark:text-gray-400">${lead.contact}</div>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(lead.status)}">
                            ${getStatusText(lead.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                        ${getSourceText(lead.source)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        ${new Date(lead.createdAt).toLocaleDateString('ru-RU')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                        ${lead.totalAmount.toLocaleString('ru-RU')} ₽
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="editLead(${lead.id})" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                                <i data-lucide="edit" class="h-4 w-4"></i>
                            </button>
                            <button onclick="openLeadCalculator(${lead.id})" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                                <i data-lucide="calculator" class="h-4 w-4"></i>
                            </button>
                            <button onclick="deleteLead(${lead.id})" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            lucide.createIcons();
        }

        function getStatusColor(status) {
            const colors = {
                'new': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                'contacted': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                'quoted': 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200',
                'negotiating': 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200',
                'won': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                'lost': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
            };
            return colors[status] || colors['new'];
        }

        function getStatusText(status) {
            const texts = {
                'new': 'Новый',
                'contacted': 'Связались',
                'quoted': 'Отправили смету',
                'negotiating': 'Переговоры',
                'won': 'Закрыт успешно',
                'lost': 'Закрыт неуспешно'
            };
            return texts[status] || 'Новый';
        }

        function getSourceText(source) {
            const texts = {
                'website': 'Сайт',
                'referral': 'Рекомендация',
                'cold-call': 'Холодный звонок',
                'social': 'Социальные сети',
                'other': 'Другое'
            };
            return texts[source] || 'Не указан';
        }

        function filterLeads() {
            const statusFilter = document.getElementById('status-filter').value;
            const sourceFilter = document.getElementById('source-filter').value;
            const searchFilter = document.getElementById('search-filter').value.toLowerCase();

            const filteredLeads = leads.filter(lead => {
                const matchesStatus = !statusFilter || lead.status === statusFilter;
                const matchesSource = !sourceFilter || lead.source === sourceFilter;
                const matchesSearch = !searchFilter || 
                    lead.clientName.toLowerCase().includes(searchFilter) ||
                    (lead.contact && lead.contact.toLowerCase().includes(searchFilter));

                return matchesStatus && matchesSource && matchesSearch;
            });

            updateLeadsTableWithData(filteredLeads);
        }

        function updateLeadsTableWithData(leadsData) {
            const tbody = document.getElementById('leadsTableBody');
            
            if (leadsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                            Лиды не найдены по заданным фильтрам.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = leadsData.map(lead => `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900 dark:text-white">${lead.clientName}</div>
                            ${lead.contact ? `<div class="text-sm text-gray-500 dark:text-gray-400">${lead.contact}</div>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(lead.status)}">
                            ${getStatusText(lead.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                        ${getSourceText(lead.source)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        ${new Date(lead.createdAt).toLocaleDateString('ru-RU')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                        ${lead.totalAmount.toLocaleString('ru-RU')} ₽
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="editLead(${lead.id})" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                                <i data-lucide="edit" class="h-4 w-4"></i>
                            </button>
                            <button onclick="openLeadCalculator(${lead.id})" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                                <i data-lucide="calculator" class="h-4 w-4"></i>
                            </button>
                            <button onclick="deleteLead(${lead.id})" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            lucide.createIcons();
        }

        function clearFilters() {
            document.getElementById('status-filter').value = '';
            document.getElementById('source-filter').value = '';
            document.getElementById('search-filter').value = '';
            updateLeadsTable();
        }

        function editLead(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;

            // Fill form with lead data
            document.getElementById('leadClientName').value = lead.clientName;
            document.getElementById('leadContact').value = lead.contact;
            document.getElementById('leadSource').value = lead.source;
            document.getElementById('leadStatus').value = lead.status;
            document.getElementById('leadComments').value = lead.comments;
            document.getElementById('createCalculation').checked = false;

            showAddLeadModal();
            
            // Store lead ID for editing
            document.getElementById('addLeadModal').setAttribute('data-editing-id', leadId);
        }

        function deleteLead(leadId) {
            if (confirm('Вы уверены, что хотите удалить этот лид?')) {
                leads = leads.filter(l => l.id !== leadId);
                saveData();
                updateLeadsTable();
                if (currentTab === 'dashboard') {
                    updateDashboard();
                }
                showNotification('Лид удален', 'success');
            }
        }

        function openLeadCalculator(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;

            // Switch to calculator tab
            showTab('calculator');
            
            // Load lead data into calculator
            document.getElementById('clientName').value = lead.clientName;
            
            // If lead has calculation, load it
            if (lead.calculationId) {
                // Load calculation data (this would need to be implemented)
                showNotification('Загружен расчет для лида: ' + lead.clientName, 'info');
            } else {
                showNotification('Открыт калькулятор для лида: ' + lead.clientName, 'info');
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            const totalLeads = leads.length;
            const wonLeads = leads.filter(l => l.status === 'won').length;
            const inProgressLeads = leads.filter(l => ['contacted', 'quoted', 'negotiating'].includes(l.status)).length;
            const conversionRate = totalLeads > 0 ? Math.round((wonLeads / totalLeads) * 100) : 0;
            const averageCheck = wonLeads > 0 ? Math.round(leads.filter(l => l.status === 'won').reduce((sum, l) => sum + l.totalAmount, 0) / wonLeads) : 0;

            document.getElementById('total-leads').textContent = totalLeads;
            document.getElementById('conversion-rate').textContent = conversionRate + '%';
            document.getElementById('in-progress-leads').textContent = inProgressLeads;
            document.getElementById('average-check').textContent = averageCheck.toLocaleString('ru-RU') + ' ₽';

            updateStatusChart();
            updateRecentLeads();
        }

        function updateStatusChart() {
            const statusCounts = {};
            leads.forEach(lead => {
                statusCounts[lead.status] = (statusCounts[lead.status] || 0) + 1;
            });

            const chartContainer = document.getElementById('status-chart');
            chartContainer.innerHTML = Object.entries(statusCounts).map(([status, count]) => `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-600 dark:text-gray-300">${getStatusText(status)}</span>
                    <div class="flex items-center">
                        <div class="w-32 bg-gray-200 dark:bg-gray-600 rounded-full h-2 mr-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${(count / leads.length) * 100}%"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900 dark:text-white w-8">${count}</span>
                    </div>
                </div>
            `).join('');
        }

        function updateRecentLeads() {
            const recentLeads = leads
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 5);

            const container = document.getElementById('recent-leads');
            if (recentLeads.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Нет лидов</p>';
                return;
            }

            container.innerHTML = recentLeads.map(lead => `
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white">${lead.clientName}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">${getSourceText(lead.source)} • ${new Date(lead.createdAt).toLocaleDateString('ru-RU')}</div>
                    </div>
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(lead.status)}">
                        ${getStatusText(lead.status)}
                    </span>
                </div>
            `).join('');
        }

        // Kanban Board Functions
        function updateKanbanBoard() {
            // Update counts for each stage
            pipelineStages.forEach(stage => {
                const count = leads.filter(lead => lead.status === stage.id).length;
                const countElement = document.getElementById(`${stage.id}-leads-count`);
                if (countElement) {
                    countElement.textContent = count;
                }
            });

            // Update columns with lead cards
            pipelineStages.forEach(stage => {
                const columnElement = document.getElementById(`${stage.id}-leads-column`);
                if (columnElement) {
                    const stageLeads = leads.filter(lead => lead.status === stage.id);
                    columnElement.innerHTML = stageLeads.map(lead => createLeadCard(lead)).join('');
                }
            });

            // Update reminders
            updateRemindersList();
        }

        function createLeadCard(lead) {
            const leadData = leads.find(l => l.id === lead.id);
            const hasReminders = reminders.some(r => r.leadId === lead.id && !r.completed);
            const reminderCount = reminders.filter(r => r.leadId === lead.id && !r.completed).length;

            return `
                <div class="kanban-card" draggable="true" ondragstart="dragStart(event, ${lead.id})" onclick="openLeadDetails(${lead.id})">
                    <div class="flex items-start justify-between mb-2">
                        <div class="font-medium text-sm text-gray-900 dark:text-white truncate">${lead.clientName}</div>
                        ${hasReminders ? `<span class="text-xs bg-red-100 text-red-800 px-1 rounded">${reminderCount}</span>` : ''}
                    </div>
                    ${lead.contact ? `<div class="text-xs text-gray-500 dark:text-gray-400 mb-1">${lead.contact}</div>` : ''}
                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">${getSourceText(lead.source)}</div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-medium text-gray-900 dark:text-white">${lead.totalAmount.toLocaleString('ru-RU')} ₽</span>
                        <div class="flex space-x-1">
                            <button onclick="event.stopPropagation(); addReminderForLead(${lead.id})" class="text-gray-400 hover:text-yellow-500" title="Добавить напоминание">
                                <i data-lucide="bell-plus" class="h-3 w-3"></i>
                            </button>
                            <button onclick="event.stopPropagation(); openLeadCalculator(${lead.id})" class="text-gray-400 hover:text-blue-500" title="Калькулятор">
                                <i data-lucide="calculator" class="h-3 w-3"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function dragStart(event, leadId) {
            event.dataTransfer.setData('text/plain', leadId.toString());
            event.target.classList.add('dragging');
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function drop(event, newStatus) {
            event.preventDefault();
            const leadId = parseInt(event.dataTransfer.getData('text/plain'));
            const lead = leads.find(l => l.id === leadId);
            
            if (lead && lead.status !== newStatus) {
                lead.status = newStatus;
                lead.updatedAt = new Date().toISOString();
                saveData();
                updateKanbanBoard();
                updateDashboard();
                showNotification(`Лид "${lead.clientName}" перемещен в "${getStatusText(newStatus)}"`, 'success');
            }
            
            // Remove dragging class
            document.querySelectorAll('.kanban-card').forEach(card => {
                card.classList.remove('dragging');
            });
        }

        // Reminder Functions
        function showAddReminderModal() {
            // Populate leads dropdown
            const leadsSelect = document.getElementById('reminderLeadId');
            leadsSelect.innerHTML = '<option value="">Выберите лид</option>' + 
                leads.map(lead => `<option value="${lead.id}">${lead.clientName}</option>`).join('');
            
            // Set default datetime to next hour
            const now = new Date();
            now.setHours(now.getHours() + 1, 0, 0, 0);
            document.getElementById('reminderDateTime').value = now.toISOString().slice(0, 16);
            
            document.getElementById('addReminderModal').classList.remove('hidden');
        }

        function hideAddReminderModal() {
            document.getElementById('addReminderModal').classList.add('hidden');
            document.getElementById('reminderLeadId').value = '';
            document.getElementById('reminderDateTime').value = '';
            document.getElementById('reminderText').value = '';
            document.getElementById('telegramBotToken').value = '';
            document.getElementById('telegramChatId').value = '';
        }

        function addReminder() {
            const leadId = parseInt(document.getElementById('reminderLeadId').value);
            const dateTime = document.getElementById('reminderDateTime').value;
            const text = document.getElementById('reminderText').value.trim();
            const botToken = document.getElementById('telegramBotToken').value.trim();
            const chatId = document.getElementById('telegramChatId').value.trim();

            if (!leadId || !dateTime || !text) {
                alert('Заполните все обязательные поля');
                return;
            }

            const reminder = {
                id: nextReminderId++,
                leadId: leadId,
                dateTime: dateTime,
                text: text,
                botToken: botToken,
                chatId: chatId,
                completed: false,
                createdAt: new Date().toISOString()
            };

            reminders.push(reminder);
            saveData();
            hideAddReminderModal();
            updateKanbanBoard();
            showNotification('Напоминание добавлено', 'success');

            // Schedule notification
            scheduleReminderNotification(reminder);
        }

        function addReminderForLead(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;

            // Pre-fill lead
            const leadsSelect = document.getElementById('reminderLeadId');
            leadsSelect.innerHTML = `<option value="${lead.id}" selected>${lead.clientName}</option>`;
            
            // Set default datetime to next hour
            const now = new Date();
            now.setHours(now.getHours() + 1, 0, 0, 0);
            document.getElementById('reminderDateTime').value = now.toISOString().slice(0, 16);
            
            showAddReminderModal();
        }

        function updateRemindersList() {
            const container = document.getElementById('reminders-list');
            const activeReminders = reminders.filter(r => !r.completed).sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
            
            if (activeReminders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Нет активных напоминаний</p>';
                return;
            }

            container.innerHTML = activeReminders.map(reminder => {
                const lead = leads.find(l => l.id === reminder.leadId);
                const reminderDate = new Date(reminder.dateTime);
                const now = new Date();
                const isOverdue = reminderDate < now;
                
                return `
                    <div class="reminder-item ${isOverdue ? 'bg-red-50 border-red-200 dark:bg-red-900' : ''}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900 dark:text-white">
                                    ${lead ? lead.clientName : 'Неизвестный лид'}
                                </div>
                                <div class="text-sm text-gray-600 dark:text-gray-300 mt-1">
                                    ${reminder.text}
                                </div>
                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    ${reminderDate.toLocaleString('ru-RU')}
                                    ${isOverdue ? ' (просрочено)' : ''}
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="completeReminder(${reminder.id})" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-200" title="Отметить выполненным">
                                    <i data-lucide="check" class="h-4 w-4"></i>
                                </button>
                                <button onclick="deleteReminder(${reminder.id})" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-200" title="Удалить">
                                    <i data-lucide="trash-2" class="h-4 w-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }

        function completeReminder(reminderId) {
            const reminder = reminders.find(r => r.id === reminderId);
            if (reminder) {
                reminder.completed = true;
                saveData();
                updateRemindersList();
                updateKanbanBoard();
                showNotification('Напоминание отмечено выполненным', 'success');
            }
        }

        function deleteReminder(reminderId) {
            if (confirm('Удалить это напоминание?')) {
                reminders = reminders.filter(r => r.id !== reminderId);
                saveData();
                updateRemindersList();
                updateKanbanBoard();
                showNotification('Напоминание удалено', 'success');
            }
        }

        function scheduleReminderNotification(reminder) {
            const reminderTime = new Date(reminder.dateTime).getTime();
            const now = Date.now();
            const delay = reminderTime - now;

            if (delay > 0) {
                setTimeout(() => {
                    sendTelegramNotification(reminder);
                }, delay);
            }
        }

        async function sendTelegramNotification(reminder) {
            // Use global settings if reminder doesn't have specific settings
            const botToken = reminder.botToken || globalTelegramSettings.botToken;
            const chatType = globalTelegramSettings.chatType;
            const chatId = reminder.chatId || globalTelegramSettings.chatId;
            const groupId = globalTelegramSettings.groupId;
            const userId = globalTelegramSettings.userId;

            if (!botToken) {
                console.log('Telegram bot token не настроен');
                return;
            }

            const lead = leads.find(l => l.id === reminder.leadId);
            const leadName = lead ? lead.clientName : 'Неизвестный';
            
            let targetChatId;
            let message;

            if (chatType === 'personal') {
                if (!chatId) {
                    console.log('Personal chat ID не настроен');
                    return;
                }
                targetChatId = chatId;
                message = `🔔 Напоминание\n\nКлиент: ${leadName}\nЗадача: ${reminder.text}\nВремя: ${new Date(reminder.dateTime).toLocaleString('ru-RU')}`;
            } else {
                if (!groupId || !userId) {
                    console.log('Group settings не настроены');
                    return;
                }
                targetChatId = groupId;
                const userName = currentUser ? currentUser.full_name : 'Пользователь';
                message = `🔔 Напоминание\n\nКлиент: ${leadName}\nЗадача: ${reminder.text}\nВремя: ${new Date(reminder.dateTime).toLocaleString('ru-RU')}\n\n👤 Напоминание от: <a href="tg://user?id=${userId}">${userName}</a>`;
            }

            try {
                const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: targetChatId,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });

                if (response.ok) {
                    console.log('Telegram уведомление отправлено');
                } else {
                    console.error('Ошибка отправки Telegram уведомления');
                }
            } catch (error) {
                console.error('Ошибка при отправке уведомления:', error);
            }
        }

        // Pipeline Settings Functions
        function showPipelineSettings() {
            updatePipelineStagesDisplay();
            document.getElementById('pipelineSettingsModal').classList.remove('hidden');
        }

        function hidePipelineSettings() {
            document.getElementById('pipelineSettingsModal').classList.add('hidden');
        }

        function updatePipelineStagesDisplay() {
            const container = document.getElementById('pipeline-stages');
            container.innerHTML = pipelineStages.map(stage => `
                <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex-1">
                        <input type="text" value="${stage.name}" onchange="updatePipelineStage(${stage.order}, 'name', this.value)" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-600 dark:text-white">
                    </div>
                    <div class="w-24">
                        <select onchange="updatePipelineStage(${stage.order}, 'color', this.value)" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-600 dark:text-white">
                            <option value="blue" ${stage.color === 'blue' ? 'selected' : ''}>Синий</option>
                            <option value="yellow" ${stage.color === 'yellow' ? 'selected' : ''}>Желтый</option>
                            <option value="purple" ${stage.color === 'purple' ? 'selected' : ''}>Фиолетовый</option>
                            <option value="orange" ${stage.color === 'orange' ? 'selected' : ''}>Оранжевый</option>
                            <option value="green" ${stage.color === 'green' ? 'selected' : ''}>Зеленый</option>
                            <option value="red" ${stage.color === 'red' ? 'selected' : ''}>Красный</option>
                        </select>
                    </div>
                    <button onclick="removePipelineStage(${stage.order})" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-200">
                        <i data-lucide="trash-2" class="h-4 w-4"></i>
                    </button>
                </div>
            `).join('');

            lucide.createIcons();
        }

        function updatePipelineStage(order, field, value) {
            const stage = pipelineStages.find(s => s.order === order);
            if (stage) {
                stage[field] = value;
                saveData();
            }
        }

        function addPipelineStage() {
            const newOrder = Math.max(...pipelineStages.map(s => s.order)) + 1;
            const newStage = {
                id: `stage_${newOrder}`,
                name: 'Новый этап',
                color: 'blue',
                order: newOrder
            };
            pipelineStages.push(newStage);
            updatePipelineStagesDisplay();
        }

        function removePipelineStage(order) {
            if (confirm('Удалить этот этап? Лиды в этом этапе будут перемещены в "Новые лиды".')) {
                pipelineStages = pipelineStages.filter(s => s.order !== order);
                // Move leads from deleted stage to 'new'
                leads.forEach(lead => {
                    if (lead.status === `stage_${order}`) {
                        lead.status = 'new';
                    }
                });
                saveData();
                updatePipelineStagesDisplay();
                updateKanbanBoard();
            }
        }

        function savePipelineSettings() {
            saveData();
            hidePipelineSettings();
            updateKanbanBoard();
            showNotification('Настройки воронки сохранены', 'success');
        }

        function openLeadDetails(leadId) {
            // Switch to leads tab and highlight the lead
            showTab('leads');
            // You could add highlighting logic here
        }

        // Initialize reminder checking
        function checkReminders() {
            const now = new Date();
            reminders.forEach(reminder => {
                if (!reminder.completed && new Date(reminder.dateTime) <= now) {
                    // Show browser notification if available
                    if ('Notification' in window && Notification.permission === 'granted') {
                        const lead = leads.find(l => l.id === reminder.leadId);
                        new Notification(`Напоминание: ${lead ? lead.clientName : 'Неизвестный лид'}`, {
                            body: reminder.text,
                            icon: '/favicon.ico'
                        });
                    }
                }
            });
        }

        // Request notification permission
        if ('Notification' in window) {
            Notification.requestPermission();
        }

        // Check reminders every minute
        setInterval(checkReminders, 60000);

        // Update connection status
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const dotElement = document.getElementById('statusDot');
            const textElement = document.getElementById('statusText');

            if (isOnline) {
                statusElement.className = 'flex items-center px-3 py-1 rounded-lg online';
                dotElement.className = 'w-2 h-2 rounded-full mr-2 online';
                textElement.textContent = 'Онлайн';
            } else {
                statusElement.className = 'flex items-center px-3 py-1 rounded-lg offline';
                dotElement.className = 'w-2 h-2 rounded-full mr-2 offline';
                textElement.textContent = 'Офлайн';
            }
        }

        // Update status on load
        document.addEventListener('DOMContentLoaded', updateConnectionStatus);

        // Notification Settings Functions
        function showNotificationSettings() {
            // Load current settings
            document.getElementById('globalTelegramBotToken').value = globalTelegramSettings.botToken;
            document.getElementById('telegramChatType').value = globalTelegramSettings.chatType;
            document.getElementById('globalTelegramChatId').value = globalTelegramSettings.chatId;
            document.getElementById('globalTelegramGroupId').value = globalTelegramSettings.groupId;
            document.getElementById('globalTelegramUserId').value = globalTelegramSettings.userId;
            
            // Toggle chat type settings
            toggleChatTypeSettings();
            
            // Update notification status
            updateNotificationStatus();
            
            // Update reminders list
            updateGlobalRemindersList();
            
            document.getElementById('notificationSettingsModal').classList.remove('hidden');
        }

        function toggleChatTypeSettings() {
            const chatType = document.getElementById('telegramChatType').value;
            const personalSettings = document.getElementById('personalChatSettings');
            const groupSettings = document.getElementById('groupChatSettings');
            
            if (chatType === 'personal') {
                personalSettings.classList.remove('hidden');
                groupSettings.classList.add('hidden');
            } else {
                personalSettings.classList.add('hidden');
                groupSettings.classList.remove('hidden');
            }
        }

        function hideNotificationSettings() {
            document.getElementById('notificationSettingsModal').classList.add('hidden');
        }

        function saveNotificationSettings() {
            globalTelegramSettings.botToken = document.getElementById('globalTelegramBotToken').value.trim();
            globalTelegramSettings.chatType = document.getElementById('telegramChatType').value;
            globalTelegramSettings.chatId = document.getElementById('globalTelegramChatId').value.trim();
            globalTelegramSettings.groupId = document.getElementById('globalTelegramGroupId').value.trim();
            globalTelegramSettings.userId = document.getElementById('globalTelegramUserId').value.trim();
            
            saveData();
            hideNotificationSettings();
            showNotification('Настройки уведомлений сохранены', 'success');
        }

        function testTelegramConnection() {
            const botToken = document.getElementById('globalTelegramBotToken').value.trim();
            const chatType = document.getElementById('telegramChatType').value;
            const chatId = document.getElementById('globalTelegramChatId').value.trim();
            const groupId = document.getElementById('globalTelegramGroupId').value.trim();
            const userId = document.getElementById('globalTelegramUserId').value.trim();

            if (!botToken) {
                alert('Заполните токен бота');
                return;
            }

            let targetChatId;
            let testMessage;

            if (chatType === 'personal') {
                if (!chatId) {
                    alert('Заполните Chat ID для личных сообщений');
                    return;
                }
                targetChatId = chatId;
                testMessage = '🔔 Тестовое сообщение от FF Dashboard\n\nЕсли вы видите это сообщение, настройки работают корректно!';
            } else {
                if (!groupId || !userId) {
                    alert('Заполните Group ID и User ID для групповых сообщений');
                    return;
                }
                targetChatId = groupId;
                testMessage = `🔔 Тестовое сообщение от FF Dashboard\n\nЕсли вы видите это сообщение, настройки работают корректно!\n\n👤 Напоминание от: <a href="tg://user?id=${userId}">пользователя</a>`;
            }

            fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: targetChatId,
                    text: testMessage,
                    parse_mode: 'HTML'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    showNotification('Тестовое сообщение отправлено успешно!', 'success');
                } else {
                    showNotification(`Ошибка: ${data.description}`, 'error');
                }
            })
            .catch(error => {
                showNotification(`Ошибка подключения: ${error.message}`, 'error');
            });
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    updateNotificationStatus();
                    if (permission === 'granted') {
                        showNotification('Уведомления разрешены', 'success');
                    } else {
                        showNotification('Уведомления заблокированы', 'error');
                    }
                });
            } else {
                showNotification('Браузер не поддерживает уведомления', 'error');
            }
        }

        function updateNotificationStatus() {
            const statusElement = document.getElementById('notificationStatus');
            const buttonElement = document.getElementById('notificationPermissionBtn');
            
            if ('Notification' in window) {
                const permission = Notification.permission;
                if (permission === 'granted') {
                    statusElement.textContent = '✅ Уведомления разрешены';
                    buttonElement.textContent = 'Разрешено';
                    buttonElement.classList.remove('bg-green-600', 'hover:bg-green-700');
                    buttonElement.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    buttonElement.disabled = true;
                } else if (permission === 'denied') {
                    statusElement.textContent = '❌ Уведомления заблокированы';
                    buttonElement.textContent = 'Заблокировано';
                    buttonElement.classList.remove('bg-green-600', 'hover:bg-green-700');
                    buttonElement.classList.add('bg-red-600', 'hover:bg-red-700');
                    buttonElement.disabled = true;
                } else {
                    statusElement.textContent = '⚠️ Разрешение не запрошено';
                    buttonElement.textContent = 'Разрешить';
                    buttonElement.classList.remove('bg-gray-600', 'hover:bg-gray-700', 'bg-red-600', 'hover:bg-red-700');
                    buttonElement.classList.add('bg-green-600', 'hover:bg-green-700');
                    buttonElement.disabled = false;
                }
            } else {
                statusElement.textContent = '❌ Браузер не поддерживает уведомления';
                buttonElement.disabled = true;
            }
        }

        function updateGlobalRemindersList() {
            const container = document.getElementById('globalRemindersList');
            const activeReminders = reminders.filter(r => !r.completed).sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
            
            if (activeReminders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Нет активных напоминаний</p>';
                return;
            }

            container.innerHTML = activeReminders.map(reminder => {
                const lead = leads.find(l => l.id === reminder.leadId);
                const reminderDate = new Date(reminder.dateTime);
                const now = new Date();
                const isOverdue = reminderDate < now;
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900 dark:text-white">
                                ${lead ? lead.clientName : 'Неизвестный лид'}
                            </div>
                            <div class="text-sm text-gray-600 dark:text-gray-300">
                                ${reminder.text}
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                ${reminderDate.toLocaleString('ru-RU')}
                                ${isOverdue ? ' (просрочено)' : ''}
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="completeReminder(${reminder.id})" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-200" title="Отметить выполненным">
                                <i data-lucide="check" class="h-4 w-4"></i>
                            </button>
                            <button onclick="deleteReminder(${reminder.id})" class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-200" title="Удалить">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }

        // Update reminder functions to use global settings
        function addReminder() {
            const leadId = parseInt(document.getElementById('reminderLeadId').value);
            const dateTime = document.getElementById('reminderDateTime').value;
            const text = document.getElementById('reminderText').value.trim();
            const botToken = document.getElementById('telegramBotToken').value.trim() || globalTelegramSettings.botToken;
            const chatId = document.getElementById('telegramChatId').value.trim() || globalTelegramSettings.chatId;

            if (!leadId || !dateTime || !text) {
                alert('Заполните все обязательные поля');
                return;
            }

            const reminder = {
                id: nextReminderId++,
                leadId: leadId,
                dateTime: dateTime,
                text: text,
                botToken: botToken,
                chatId: chatId,
                completed: false,
                createdAt: new Date().toISOString()
            };

            reminders.push(reminder);
            saveData();
            hideAddReminderModal();
            updateKanbanBoard();
            showNotification('Напоминание добавлено', 'success');

            // Schedule notification
            scheduleReminderNotification(reminder);
        }
    </script>
</body>
</html>
